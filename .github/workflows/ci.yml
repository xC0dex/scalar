name: CI

# This workflow runs on:
# 1. Push events to the main branch
# 2. Pull request events
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch: null

env:
  # Exclude these packages from turbo as they are handled by dedicated jobs
  TURBO_FLAGS: '--concurrency=100% --filter "!./integrations/{java,rust,dotnet,docker,fastapi,django-ninja}/**" --filter "!./projects/proxy-scalar-com/**"'
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
jobs:
  # Initial build.
  # We only build the packages and integrations as everything else depends on them
  # turbo is cached to sticky disk and pnpm is cached in the standard actions cache
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Build
        uses: ./.github/actions/build
        with:
          packages: './{packages,integrations}/**'
      - name: Copy and rename standalone.js to scalar.js
        run: |
          mkdir -p temp-artifacts
          cp packages/api-reference/dist/browser/standalone.js temp-artifacts/scalar.js
      - name: Upload scalar.js artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: scalar-js
          path: temp-artifacts/scalar.js
          retention-days: 3
      - if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false)
        name: Upload webpack stats to RelativeCI
        uses: relative-ci/agent-action@1707825cbfcc7452b2913d273414705415ae64d4 # v3
        with:
          key: ${{ secrets.RELATIVE_CI_KEY }}
          token: ${{ secrets.GITHUB_TOKEN }}
          webpackStatsFile: ./packages/api-reference/dist/browser/webpack-stats.json

  check-changes:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      dotnet_changed: ${{ steps.set-outputs.outputs.dotnet_changed }}
      java_changed: ${{ steps.set-outputs.outputs.java_changed }}
      fastapi_changed: ${{ steps.set-outputs.outputs.fastapi_changed }}
      django_ninja_changed: ${{ steps.set-outputs.outputs.django_ninja_changed }}
      rust_changed: ${{ steps.set-outputs.outputs.rust_changed }}
      docker_changed: ${{ steps.set-outputs.outputs.docker_changed }}
      aspnetcore_package_changed: ${{ steps.set-outputs.outputs.aspnetcore_package_changed }}
      aspire_package_changed: ${{ steps.set-outputs.outputs.aspire_package_changed }}
      fastapi_package_changed: ${{ steps.set-outputs.outputs.fastapi_package_changed }}
      django_ninja_package_changed: ${{ steps.set-outputs.outputs.django_ninja_package_changed }}
      rust_package_changed: ${{ steps.set-outputs.outputs.rust_package_changed }}
      java_package_changed: ${{ steps.set-outputs.outputs.java_package_changed }}
      docker_package_changed: ${{ steps.set-outputs.outputs.docker_package_changed }}
      icons_changed: ${{ steps.set-outputs.outputs.icons_changed }}
      galaxy_changed: ${{ steps.set-outputs.outputs.galaxy_changed }}
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Check whether integration files were modified
        id: changed-integration-files
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files_yaml: |
            dotnet_integration:
              - integrations/dotnet/**
            java_integration:
              - integrations/java/**
            fastapi_integration:
              - integrations/fastapi/**
            rust_integration:
              - integrations/rust/**
            docker_integration:
              - integrations/docker/**
            django_ninja_integration:
              - integrations/django-ninja/**

      - name: Check whether packages files were modified
        id: changed-packages-files
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files_yaml: |
            icons_changed:
              - packages/icons/**
              - packages/components/src/components/ScalarIcon/**
            galaxy_changed:
              - packages/galaxy/**

      - name: Check whether integration package.json files were modified
        id: changed-package-files
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files_yaml: |
            aspnetcore_package:
              - integrations/dotnet/aspnetcore/package.json
            aspire_package:
              - integrations/dotnet/aspire/package.json
            fastapi_package:
              - integrations/fastapi/package.json
            django_ninja_package:
              - integrations/django-ninja/package.json
            rust_package:
              - integrations/rust/package.json
            java_package:
              - integrations/java/package.json
            docker_package:
              - integrations/docker/package.json


      - name: Set job outputs
        id: set-outputs
        run: |
          echo "dotnet_changed=${{ steps.changed-integration-files.outputs.dotnet_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "java_changed=${{ steps.changed-integration-files.outputs.java_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "fastapi_changed=${{ steps.changed-integration-files.outputs.fastapi_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "django_ninja_changed=${{ steps.changed-integration-files.outputs.django_ninja_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "rust_changed=${{ steps.changed-integration-files.outputs.rust_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "docker_changed=${{ steps.changed-integration-files.outputs.docker_integration_any_changed }}" >> $GITHUB_OUTPUT
          echo "aspnetcore_package_changed=${{ steps.changed-package-files.outputs.aspnetcore_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "aspire_package_changed=${{ steps.changed-package-files.outputs.aspire_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "fastapi_package_changed=${{ steps.changed-package-files.outputs.fastapi_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "django_ninja_package_changed=${{ steps.changed-package-files.outputs.django_ninja_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "rust_package_changed=${{ steps.changed-package-files.outputs.rust_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "java_package_changed=${{ steps.changed-package-files.outputs.java_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "docker_package_changed=${{ steps.changed-package-files.outputs.docker_package_any_changed }}" >> $GITHUB_OUTPUT
          echo "icons_changed=${{ steps.changed-packages-files.outputs.icons_changed_any_changed }}" >> $GITHUB_OUTPUT
          echo "galaxy_changed=${{ steps.changed-packages-files.outputs.galaxy_changed_any_changed }}" >> $GITHUB_OUTPUT

  create-github-release:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
      - name: Generate release tag
        id: tag
        run: |
          DATE=$(date +%Y-%m-%d)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          TAG="release-${DATE}-${SHORT_SHA}"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      - name: Create GitHub Release
        run: |
          gh release create "${{ steps.tag.outputs.tag }}" \
            --generate-notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  todesktop-build:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Build
        uses: ./.github/actions/build
        with:
          packages: './{packages,integrations,projects}/**'
      - name: Git Status
        run: git status
      - name: Stash changes
        run: git stash
      - name: Check whether appFiles are there
        run: ls -R ./projects/scalar-app/dist
      - if: startsWith(github.event.head_commit.message, 'RELEASING:')
        name: Check whether there's a new version of the app
        id: changed-files
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files_yaml: |
            api_client_app:
              - projects/scalar-app/package.json
      - if: steps.changed-files.outputs.api_client_app_any_changed == 'true'
        name: Check whether appFiles are there
        run: ls -R ./projects/scalar-app/dist
      - if: steps.changed-files.outputs.api_client_app_any_changed == 'true'
        name: Build in the toDesktop cloud
        run: pnpm --filter scalar-app todesktop:build:ci
        env:
          TODESKTOP_EMAIL: ${{ secrets.TODESKTOP_EMAIL }}
          TODESKTOP_ACCESS_TOKEN: ${{ secrets.TODESKTOP_ACCESS_TOKEN }}

  deploy-api-client:
    # Only run this job for PRs from the same repository
    if: github.ref == 'refs/heads/main' || github.event.pull_request.head.repo.full_name == github.repository
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Check which files were touched
        id: changed-files
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files_yaml: |
            api_client:
              - projects/client-scalar-com/**
              - packages/api-client/**
      - if: steps.changed-files.outputs.api_client_any_changed == 'true'
        name: Build
        uses: ./.github/actions/build
        with:
          packages: 'client-scalar-com...'
      - if: steps.changed-files.outputs.api_client_any_changed == 'true'
        name: Deploy to client.staging.scalar.com (staging)
        id: deploy-client-staging
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          command: pages deploy dist --project-name=client-staging
          workingDirectory: projects/client-scalar-com
          # 1) Log in to the Cloudflare dashboard.
          # 2) Select Workers & Pages.
          # 3) See the Account ID in the right sidebar.
          # Read more: https://developers.cloudflare.com/fundamentals/setup/find-account-and-zone-ids/
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # 1) Go to https://dash.cloudflare.com/profile/api-tokens
          # 2) Create a token with the following permissions:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      - if: github.ref != 'refs/heads/main' && steps.deploy-client-staging.outputs.deployment-url
        name: Add Cloudflare Preview URL to the PR
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3
        with:
          message: |
            **Cloudflare Preview for the API Client**

            ${{ steps.deploy-client-staging.outputs.deployment-url }}
          comment-tag: 'cloudflare-preview'
      - if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
        name: Check for new @scalar/api-client version
        id: client-version
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files_yaml: |
            api_client:
              - packages/api-client/**
      - if: steps.client-version.outputs.api_client_any_changed == 'true'
        name: Deploy to client.scalar.com (production)
        id: deploy-client-production
        uses: cloudflare/wrangler-action@da0e0dfe58b7a431659754fdf3f186c529afbe65 # v3
        with:
          command: pages deploy dist --project-name=client
          workingDirectory: projects/client-scalar-com
          # 1) Log in to the Cloudflare dashboard.
          # 2) Select Workers & Pages.
          # 3) See the Account ID in the right sidebar.
          # Read more: https://developers.cloudflare.com/fundamentals/setup/find-account-and-zone-ids/
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # 1) Go to https://dash.cloudflare.com/profile/api-tokens
          # 2) Create a token with the following permissions:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  push-to-scalar-registry:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build]

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Build @scalar/galaxy
        uses: ./.github/actions/build
        with:
          packages: '@scalar/galaxy...'
      - name: Check whether there's a new version of @scalar/galaxy
        id: changed-files
        uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46
        with:
          files_yaml: |
            galaxy:
              - packages/galaxy/**
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Extract version from package.json
        working-directory: packages/galaxy
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Login to Scalar Registry
        run: npx @scalar/cli@latest auth login --token ${{ secrets.SCALAR_API_KEY }}
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Push OpenAPI Example to Scalar Registry
        run: npx @scalar/cli@latest registry publish --namespace scalar --slug galaxy --version ${{ env.VERSION }} packages/galaxy/dist/latest.yaml
      - if: steps.changed-files.outputs.galaxy_any_changed == 'true'
        name: Push AsyncAPI Example to Scalar Registry
        # We're uploading it as a schema, because for documents do not support AsyncAPI yet.
        run: npx @scalar/cli@latest schema publish --namespace scalar --slug asyncapi --version ${{ env.VERSION }} packages/galaxy/dist/asyncapi/latest.yaml

  deploy-api-reference:
    # Run only for PRs from the same repository
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]')
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: deploy-api-reference-${{ github.ref }}
      cancel-in-progress: ${{ github.event_name == 'pull_request' }}
    outputs:
      preview-url: ${{ steps.set-output.outputs.url }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Build
        uses: ./.github/actions/build
        with:
          packages: '@scalar-examples/web...'

      - name: Generate DEPLOY_ID
        run: echo "DEPLOY_ID=$(pnpx uuid)" >> "$GITHUB_ENV"

      - name: Install Netlify CLI
        run: pnpm install -g netlify

      - name: Deploy to Netlify
        run: |
          netlify deploy --dir "./examples/web/dist" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_PREVIEW }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar-examples/web \
            --alias=${{env.DEPLOY_ID}}

      - name: Set output
        id: set-output
        if: github.event_name == 'pull_request'
        run: echo "url=https://${{ env.DEPLOY_ID }}--scalar-deploy-preview.netlify.app" >> $GITHUB_OUTPUT

  deploy-components:
    # Run for PRs (preview) or main branch (production)
    if: |
      (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository && !contains(github.actor, '[bot]')) ||
      github.ref == 'refs/heads/main'
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: deploy-components-${{ github.ref }}
      cancel-in-progress: ${{ github.event_name == 'pull_request' }}
    outputs:
      preview-url: ${{ steps.set-output.outputs.url }}
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Build
        uses: ./.github/actions/build
        with:
          packages: './packages/**'

      - name: Generate DEPLOY_ID
        run: echo "DEPLOY_ID=$(pnpx uuid)" >> "$GITHUB_ENV"

      - name: Install Netlify CLI
        run: pnpm install -g netlify

      - name: Build storybook
        run: pnpm --filter components build:storybook

      - name: Deploy Storybook to Netlify (Preview)
        if: github.event_name == 'pull_request'
        run: |
          netlify deploy --dir "./packages/components/storybook-static" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_COMPONENTS }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar/components \
            --alias=${{env.DEPLOY_ID}}

      - name: Deploy Storybook to Netlify (Production)
        if: github.ref == 'refs/heads/main'
        run: |
          netlify deploy --dir "./packages/components/storybook-static" \
            --message "Deployed from GitHub (${{ env.DEPLOY_ID }})" \
            --site ${{ vars.NETLIFY_SITE_ID_COMPONENTS }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --filter @scalar/components \
            --prod

      - name: Set output
        id: set-output
        if: github.event_name == 'pull_request'
        run: echo "url=https://${{ env.DEPLOY_ID }}--scalar-components.netlify.app" >> $GITHUB_OUTPUT

  galaxy-registry-preview:
    # Only run for PRs from the same repository
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !contains(github.actor, '[bot]') &&
      needs.check-changes.outputs.galaxy_changed == 'true'
    needs: [build, check-changes]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write
    outputs:
      preview-url: ${{ steps.set-preview-url.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Build @scalar/galaxy
        uses: ./.github/actions/build
        with:
          packages: '@scalar/galaxy...'

      - name: Extract version and generate preview version
        id: preview-version
        working-directory: packages/galaxy
        env:
          GITHUB_HEAD_REF: ${{ github.head_ref }}
        run: |
          VERSION=$(node -p "require('./package.json').version")
          BRANCH_NAME=$(echo "$GITHUB_HEAD_REF" | sed 's/[^a-zA-Z0-9-]/-/g')
          PREVIEW_VERSION="${VERSION}-${BRANCH_NAME}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "PREVIEW_VERSION=$PREVIEW_VERSION" >> $GITHUB_ENV
          echo "version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT

      - name: Login to Scalar Registry
        run: npx @scalar/cli@latest auth login --token ${{ secrets.SCALAR_API_KEY }}

      - name: Publish preview version to Scalar Registry
        run: npx @scalar/cli@latest --version && npx @scalar/cli@latest registry publish --namespace scalar --slug galaxy --version ${{ env.PREVIEW_VERSION }} --force --no-current packages/galaxy/dist/latest.yaml

      - name: Set preview URL output
        id: set-preview-url
        run: echo "url=https://registry.scalar.com/@scalar/apis/galaxy/${{ env.PREVIEW_VERSION }}" >> $GITHUB_OUTPUT

  preview-comment:
    # Only run for PRs from the same repository
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      github.event.pull_request.head.repo.full_name == github.repository &&
      !contains(github.actor, '[bot]')
    needs: [deploy-api-reference, deploy-components, galaxy-registry-preview]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: write
    steps:
      - name: Build comment message
        id: build-message
        run: |
          MESSAGE="**Preview Examples**

          ${{ needs.deploy-api-reference.outputs.preview-url }}

          **Preview Storybook**

          ${{ needs.deploy-components.outputs.preview-url }}"

          if [ "${{ needs.galaxy-registry-preview.result }}" == "success" ]; then
            MESSAGE="$MESSAGE

          **Scalar Registry Preview**

          ${{ needs.galaxy-registry-preview.outputs.preview-url }}"
          fi

          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Add combined preview URLs to the PR
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b # v3
        with:
          message: ${{ steps.build-message.outputs.message }}
          comment-tag: 'deployment-preview'

  # ---------------------------------------------------------------------------------------------------------
  # Integration builds, tests, and publishes

  docker-build-scan:
    if: needs.check-changes.outputs.docker_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/docker/assets

      - name: Compress static assets
        working-directory: integrations/docker/assets
        run: gzip --keep --verbose --force scalar.js

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@18cdb72d11863d893251661972f9948b7b2e5f55 # v1
        with:
          platforms: linux/amd64

      - name: Build Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: integrations/docker
          file: integrations/docker/Dockerfile
          load: true
          tags: scalarapi/api-reference:latest

      - name: Scan for vulnerabilities
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: 'image'
          image-ref: 'scalarapi/api-reference:latest'
          format: 'table'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  docker-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.docker_package_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: docker-publish
      cancel-in-progress: false
    needs: [required-jobs-main, docker-build-scan, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Get version from package.json
        id: package-version
        working-directory: integrations/docker
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/docker/assets

      - name: Compress static assets
        working-directory: integrations/docker/assets
        run: gzip --keep --verbose --force scalar.js

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@18cdb72d11863d893251661972f9948b7b2e5f55 # v1
        with:
          platforms: |
            linux/amd64
            linux/arm64

      - name: Log in to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          # Username of your Docker account
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          # https://app.docker.com/settings/personal-access-tokens
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: integrations/docker
          file: integrations/docker/Dockerfile
          push: true
          platforms: |
            linux/amd64
            linux/arm64
          tags: |
            scalarapi/api-reference:latest
            scalarapi/api-reference:${{ steps.package-version.outputs.VERSION }}

  dotnet-build-test:
    if: needs.check-changes.outputs.dotnet_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: temp-assets

      - name: Copy scalar.js to aspnetcore and aspire
        run: |
          cp temp-assets/scalar.js integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets/
          cp temp-assets/scalar.js integrations/dotnet/aspire/src/Scalar.Aspire.Service/wwwroot/

      - name: Compress static assets (aspnetcore)
        working-directory: integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets
        run: gzip --keep --verbose --force scalar.js scalar.aspnetcore.js favicon.svg

      - name: Cache NuGet packages
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
        with:
          key: ${{ github.repository }}-nuget-${{ hashFiles('integrations/dotnet/**/*.csproj', 'integrations/dotnet/**/Directory.Packages.props') }}
          path: ${{ env.NUGET_PACKAGES }}

      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5
        with:
          dotnet-version: |
            10.x
            9.x
            8.x

      - name: Restore dependencies
        working-directory: integrations/dotnet
        run: dotnet restore

      - name: Build solution
        working-directory: integrations/dotnet
        run: dotnet build -c Release --no-restore

      - name: Test solution
        working-directory: integrations/dotnet
        run: dotnet test -c Release --no-build

  aspnetcore-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.aspnetcore_package_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # We don't want to run `nuget push` (publishing to NuGet) in parallel.
    concurrency:
      group: aspnetcore-publish
      cancel-in-progress: false
    needs: [required-jobs-main, dotnet-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Git Status
        run: git status

      - name: Stash changes
        run: git stash

      - name: Extract version from package.json
        working-directory: integrations/dotnet/aspnetcore
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets

      - name: Compress static assets
        working-directory: integrations/dotnet/aspnetcore/src/Scalar.AspNetCore/StaticAssets
        run: gzip --keep --verbose --force scalar.js scalar.aspnetcore.js favicon.svg

      - name: Cache NuGet packages
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
        with:
          key: ${{ github.repository }}-nuget-${{ hashFiles('integrations/dotnet/**/*.csproj', 'integrations/dotnet/**/Directory.Packages.props') }}
          path: ${{ env.NUGET_PACKAGES }}

      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5
        with:
          dotnet-version: 10.x

      - name: Restore dependencies
        working-directory: integrations/dotnet/aspnetcore
        run: dotnet restore

      - name: Pack packages
        working-directory: integrations/dotnet/aspnetcore
        run: |
          dotnet pack src/Scalar.AspNetCore -c Release --no-restore --output nupkgs /p:Version=$VERSION
          dotnet pack src/Scalar.AspNetCore.Microsoft -c Release --no-restore --output nupkgs /p:Version=$VERSION
          dotnet pack src/Scalar.AspNetCore.Swashbuckle -c Release --no-restore --output nupkgs /p:Version=$VERSION

      - name: Publish packages
        working-directory: integrations/dotnet/aspnetcore
        run: dotnet nuget push nupkgs/*.nupkg -k ${{ secrets.NUGET_TOKEN }} -s https://api.nuget.org/v3/index.json

  aspire-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.aspire_package_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: aspire-publish
      cancel-in-progress: false
    needs: [required-jobs-main, dotnet-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Git Status
        run: git status

      - name: Stash changes
        run: git stash

      - name: Extract version from package.json
        working-directory: integrations/dotnet/aspire
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/dotnet/aspire/src/Scalar.Aspire.Service/wwwroot

      - name: Log in to DockerHub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3

      - name: Setup Docker Builder
        uses: useblacksmith/setup-docker-builder@18cdb72d11863d893251661972f9948b7b2e5f55 # v1
        with:
          platforms: |
            linux/amd64
            linux/arm64

      - name: Build and push Aspire Docker image
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: integrations/dotnet/aspire
          file: integrations/dotnet/aspire/src/Scalar.Aspire.Service/Dockerfile
          push: true
          platforms: |
            linux/amd64
            linux/arm64
          tags: |
            scalarapi/aspire-api-reference:latest
            scalarapi/aspire-api-reference:${{ env.VERSION }}

      - name: Set version in Constants.cs
        working-directory: integrations/dotnet/aspire
        run: |
          sed -i 's/ImageTag = "latest"/ImageTag = "'$VERSION'"/' src/Scalar.Aspire/Constants.cs
          cat src/Scalar.Aspire/Constants.cs

      - name: Cache NuGet packages
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
        with:
          key: ${{ github.repository }}-nuget-${{ hashFiles('integrations/dotnet/**/*.csproj', 'integrations/dotnet/**/Directory.Packages.props') }}
          path: ${{ env.NUGET_PACKAGES }}

      - name: Setup .NET
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d # v5
        with:
          dotnet-version: 10.x

      - name: Restore dependencies
        working-directory: integrations/dotnet/aspire/src/Scalar.Aspire
        run: dotnet restore

      - name: Pack Scalar.Aspire NuGet package
        working-directory: integrations/dotnet/aspire/src/Scalar.Aspire
        run: dotnet pack -c Release --no-restore --output nupkgs /p:Version=$VERSION

      - name: Publish Scalar.Aspire NuGet package
        working-directory: integrations/dotnet/aspire/src/Scalar.Aspire
        run: dotnet nuget push nupkgs/*.nupkg -k ${{ secrets.NUGET_TOKEN }} -s https://api.nuget.org/v3/index.json

  fastapi-build-test:
    if: needs.check-changes.outputs.fastapi_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/fastapi
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build Python package
        working-directory: integrations/fastapi
        run: python -m build

      - name: Run tests
        working-directory: integrations/fastapi
        run: python run_tests.py

  fastapi-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.fastapi_package_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: fastapi-publish
      cancel-in-progress: false
    needs: [required-jobs-main, fastapi-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/fastapi
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build FastAPI package
        working-directory: integrations/fastapi
        run: python -m build

      - name: Publish FastAPI package to PyPI
        working-directory: integrations/fastapi
        run: |
          twine upload --username __token__ --password ${{ secrets.PYPI_TOKEN }} dist/*

  django-ninja-build-test:
    if: needs.check-changes.outputs.django_ninja_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/django-ninja
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build Python package
        working-directory: integrations/django-ninja
        run: python -m build

      - name: Run tests
        working-directory: integrations/django-ninja
        run: python run_tests.py

  django-ninja-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.django_ninja_package_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: django-ninja-publish
      cancel-in-progress: false
    needs: [required-jobs-main, django-ninja-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Setup Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: '3.11'

      - name: Install build dependencies
        working-directory: integrations/django-ninja
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build Django Ninja package
        working-directory: integrations/django-ninja
        run: python -m build

      - name: Publish Django Ninja package to PyPI
        working-directory: integrations/django-ninja
        run: |
          twine upload --username __token__ --password ${{ secrets.PYPI_TOKEN }} dist/*

  rust-build-test:
    if: needs.check-changes.outputs.rust_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/rust/ui

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check Rust code formatting
        working-directory: integrations/rust
        run: cargo fmt -- --check

      - name: Run Clippy
        working-directory: integrations/rust
        run: cargo clippy -- -D warnings

      - name: Run tests
        working-directory: integrations/rust
        run: cargo test

      - name: Run tests with all features
        working-directory: integrations/rust
        run: cargo test --features axum,actix-web,warp

      - name: Build examples
        working-directory: integrations/rust
        run: |
          cargo build --example axum --features axum
          cargo build --example actix --features actix-web
          cargo build --example warp --features warp

  rust-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.rust_package_changed == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    concurrency:
      group: rust-publish
      cancel-in-progress: false
    needs: [required-jobs-main, rust-build-test, check-changes]
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/rust/ui

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Extract version from package.json
        working-directory: integrations/rust
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update Cargo.toml version
        working-directory: integrations/rust
        run: |
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
          cat Cargo.toml | grep version

      - name: Publish to crates.io
        working-directory: integrations/rust
        run: cargo publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  java-build-test:
    if: needs.check-changes.outputs.java_changed == 'true'
    needs: [build, check-changes]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/java/scalar-core/src/main/resources/META-INF/resources/webjars/scalar
      - name: Setup Java
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          cache-dependency-path: 'integrations/java/**/pom.xml'
      - name: Run Maven tests
        working-directory: integrations/java
        run: mvn clean test

  java-publish:
    if: github.ref == 'refs/heads/main' && startsWith(github.event.head_commit.message, 'RELEASING:') && needs.check-changes.outputs.java_package_changed == 'true'
    needs: [required-jobs-main, java-build-test, check-changes]
    runs-on: ubuntu-latest
    concurrency:
      group: java-publish
      cancel-in-progress: false
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
      - name: Download scalar.js artifact
        uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          name: scalar-js
          path: integrations/java/scalar-core/src/main/resources/META-INF/resources/webjars/scalar
      - name: Setup Java
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          cache-dependency-path: '**/java/pom.xml'
          server-id: 'central'
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Extract version from package.json
        working-directory: integrations/java
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Set version in parent POM
        working-directory: integrations/java
        run: mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false
      - name: Build all Java modules
        working-directory: integrations/java
        run: mvn clean package -pl scalar-core,scalar-webmvc,scalar-webflux -am
      - name: Publish all Java modules to Maven Central
        working-directory: integrations/java
        run: mvn deploy -pl scalar-core,scalar-webmvc,scalar-webflux
        env:
          # Create an account on Sonatype and add the credentials to the repository secrets.
          # Generate User Token: https://central.sonatype.com/account
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          GPG_KEYNAME: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
  # ---------------------------------------------------------------------------------------------------------
  # Other jobs

  required-jobs-pull-requests:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    timeout-minutes: 1
    permissions: {}
    needs:
      [
        build
      ]
    steps:
      - name: Exit with error if some jobs are not successful
        run: exit 1
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'skipped') || contains(needs.*.result, 'cancelled')) }}

  required-jobs-main:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 1
    permissions: {}
    needs: [build]
    steps:
      - name: Exit with error if some jobs are not successful
        run: exit 1
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'skipped') || contains(needs.*.result, 'cancelled')) }}
